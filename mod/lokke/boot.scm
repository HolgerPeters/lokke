;;; Copyright (C) 2019 Rob Browning <rlb@defaultvalue.org>
;;;
;;; This project is free software; you can redistribute it and/or
;;; modify it under the terms of (at your option) either of the
;;; following two licences:
;;;
;;;   1) The GNU Lesser General Public License as published by the
;;;      Free Software Foundation; either version 2.1, or (at your
;;;      option) any later version
;;;
;;;   2) The Eclipse Public License; either version 1.0 or (at your
;;;      option) any later version.

;; This is the lowest level, supporting *everything*, including
;; definitions required by code generated by the compiler, etc., and
;; providing bits needed to bootstrap the system by compiling
;; clojure.core, i.e. (lokke ns clojure core).

(read-set! keywords 'postfix)  ;; srfi-88

(define-module (lokke boot)
  use-module: ((lokke ns) select: (ns))
  export: (/lokke/@
           /lokke/reader-hash-map
           /lokke/reader-hash-set
           /lokke/reader-vector
           /lokke/scoped-sym
           /lokke/scoped-ref
           syntax-quote)
  re-export: (ns quasiquote quote unquote unquote-splicing)
  duplicates: (merge-generics replace warn-override-core warn last))

(define-syntax-rule (/lokke/@ ns ref)
  (@ ns ref))

(define-syntax-rule (syntax-quote form)
  (quasiquote form))

(define-syntax /lokke/scoped-sym
  (syntax-rules (quote guile)
    ((_ sym (quote (guile)) (quote ref)) (syntax-error "No guile domain module specified by" sym))
    ((_ sym (quote (guile name ...)) (quote ref)) (/lokke/@ (name ...) ref))
    ((_ sym (quote (name ...)) (quote ref)) (/lokke/@ (lokke ns name ...) ref))))

;; FIXME: any reason these three aren't all functions or all syntax?
(define /lokke/reader-hash-map (@ (lokke hash-map) hash-map))
(define /lokke/reader-hash-set (@ (lokke hash-set) hash-set))

(define-syntax-rule (/lokke/reader-vector x ...)
  ((@ (lokke vector) vector) x ...))
